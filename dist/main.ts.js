require.config({baseUrl:"dist",paths:{typeahead:"../assets/js/typeahead.bundle.min",doT:"../assets/js/doT.min","hc-theme":"../assets/highcharts/themes/grid",anounymous:"ProtoUtil","s-t":"../assets/js/stupidtable.min"},urlArgs:"_0.743"}).onError=function(t){throw console.log(t.requireType),"timeout"===t.requireType&&console.log("modules: "+t.requireModules),t},window.Promise||(console.log("patch to support Promise"),function(){var t,e=document.getElementsByTagName("script");a="assets/js/promise-6.1.0.min.js",o=void 0,r=void 0,(t=document.createElement("script")).src=a,t.async=o,r&&e?e[0].parentNode.insertBefore(t,e[0]):document.body.appendChild(t);var a,o,r}());var global={category:null,cr:{t:"©刀小一"},startDate:"2000-01",$factSet:null,opt:null,datum:null,maxTryTimes:2,cache:!0,debug:!1};!function(t,e){t.cacheScript=function(a,o){return o=t.extend(o||{},{dataType:"script",cache:e.cache,url:a}),t.ajax(o)},t.cacheJSON=function(a,o){return o=t.extend(o||{},{dataType:"json",cache:e.cache,url:a}),t.ajax(o)},t.cacheTemplate=function(a){var o={type:"GET",dataType:"html",cache:e.cache};return Array.isArray(a)?Promise.all(a.map(function(e){return new Promise(function(a,r){t.ajax(require.s.contexts._.config.baseUrl+"tmpl/"+e.file,o).done(function(t,o,r){a({id:e.id,content:t})}).fail(function(t,e,a){r(a)})})})):new Promise(function(t,e){e("template: cannot support")})}}(jQuery,global),ErrorHandler={_$error:null,init:function(){_$error=$("#error-panel > p"),window.onerror=function(t,e,a,o,r){ErrorHandler.show(t)}},show:function(t){_$error.text(t).parent().transition("fade")},hide:function(){_$error.parent().transition("hide")}},require(["u","t","f","doT","e","peg","e0","peg0","e1","peg1","anounymous","typeahead","hc-theme","s-t"],function(t,e,a,o,r,n,l,i,c,s){$.cacheTemplate([{file:"t-sets.html",id:"__set1"},{file:"f-t.html",id:"taFactor"},{file:"f-f.html",id:"faFactor"},{file:"f-f-t.html",id:"faTable"}]).then(function(t){var e={};t.forEach(function(t){t.id.startsWith("__")?y(t.content,e):e[t.id]=o.template(t.content)}),o.tmpls=e,$(function(){global.$factSet=[$("#fact-chart-0"),$("#fact-set-0"),$("#fact-chart-1"),$("#fact-chart-2"),$("#fact-set-1"),$("#fact-set-2"),$("#security-info")],global.$lastVisit=$("#last-visit"),global.$title=$("title"),ErrorHandler.init(),$(".menu .item").tab(),Promise.all(["world","cn","hk","sg","us"].map(function(t){return new Promise(function(e,a){require([t],function(a){e(a.map(function(e){return e.cat=t,e}))})})})).then(function(t){var e=[];t.forEach(function(t){e=e.concat(t)});var a=window.location.hash;if(a){var r=/#(\^?\w+):([a-z]*)/g.exec(decodeURIComponent(a));if(r&&3===r.length){var n=r[1].toUpperCase(),l=r[2].toLowerCase();global.category=l,h(e.find(function(t){return global.$title.text(t.n),t.c===n&&t.cat===l}))}$("#symbol").remove(),global.$lastVisit.remove()}else $("#symbol").focus(function(){$(this).select()}).typeahead({hint:!1,highlight:!0},{displayKey:"c",source:function(t,a){var o=50;t=t.toUpperCase();a(e.filter(function(e){if(o>0&&(e.c.startsWith(t)||e.n.startsWith(t)))return o--,e}))},updater:function(t){},templates:{suggestion:o.tmpls.ticker}}).on("typeahead:selected",function(t,e,a){global.category=e.cat,h(e)}),b.refreshUI(),global.$lastVisit.on("click",".close",function(t){var e=$(this);b.remove(e.prev().attr("href"))&&(e.prev().remove(),e.remove())})}).catch(function(t){console.log("broken: "+t)}),$("#startDate").val(global.startDate).change(function(){var t=$(this).val();t&&t.length>0&&(t=t.replace("-","")),global.startDate=t}),$("#refreshBtn").click(function(){u(global.period,global.maxTryTimes)}),$(".message .close").on("click",function(){$(this).closest(".message").transition("fade")}),"localhost"===window.location.hostname?$("#add2watch").click(function(){if(global.opt){var t={n:global.datum.n,s:global.datum.c+":"+global.category,c:global.opt.c,o:global.opt.o,r:global.opt.r};console.dir(t),$.ajax({url:"http://localhost:3000/api/watchlist",crossDomain:!0,method:"POST",dataType:"json",data:t}).done(function(t){t.err?alert(t.msg):alert("done")})}}):$("#add2watch").remove()})}).catch(function(t){console.error(t)});var g=function(t){global.cr.x||(global.cr.x=t.plotWidth+t.plotLeft-100,global.cr.y=t.plotHeight+t.plotTop-10),t.renderer.text(global.cr.t,global.cr.x,global.cr.y).css({color:"#ccc",fontSize:"2em"}).attr({zIndex:99}).add()},h=function(e){global.period=t.getPeriod(global.category),global.datum=e,u(global.period,global.maxTryTimes)},u=function(h,d){var y=global.$factSet,v=global.datum,k=t.getCounterUrl(v.c,global.category,h),x=t.getFaUrl(global.category,v.c);d--;for(var _=0;_<6;_++)y[_].text("");y[6].next().text("SECTOR").next().text("CAPITAL"),ErrorHandler.hide(),$.cacheScript(k).done(function(u,d){data=data.filter(function(t){return t[0]>global.startDate});var k=t.processData(data,{period:h,pv:v.pv});global.opt={c:k.cagr.CAGR,o:k.optimism,r:k.formula.r2},y[6].text(v.n).next().text(v.s),y[0].highcharts(e.getChartOptions(k),g);var _=t.Calc.ta(k),w={p:_.major.p,cagr:_.major.cagr,opt:_.opt};y[1].html(p(_)).find(".tooltip").popup({inline:!0}),"sg"==global.category||"us"==global.category?v.mv&&y[6].next().next().text("Shares {0} M, MarketCap: {1} M".format(v.mv.toFixed(4),(v.mv*w.p).toFixed(4))):"cn"!=global.category||v.c.startsWith("8")||v.c.startsWith("S")||(y[6].next().next().text("总股本 {0} 亿（{1}%流通），总市值 {2} 亿".format(Math.trunc(v.mv/1e3)/10,v.mv>0?Math.trunc(v.nv/v.mv*1e3)/10:NaN,Math.trunc(v.mv*w.p/1e3)/10)),$.cacheJSON(x).done(function(e,g){var h=t.toSeries(e.lastn),u=t.toSeries(e.ttm);global.debug||(y[2].highcharts(a.getChartOptions("FA - Annual",h)),y[3].highcharts(a.getChartOptions("FA - TTM",u)));var p=t.Calc.fa(w,h.roe);p.ttm=t.Calc.gn(w,u),p.peg=n[v.c],m(p.peg,"201711"),p.ee=r[v.c],p.peg0=i[v.c],m(p.peg0,"201704"),p.ee0=l[v.c],p.peg1=s[v.c],m(p.peg1,"201612"),p.ee1=c[v.c],y[4].html(f(p)).find(".tooltip").popup({inline:!0}),y[5].html(o.tmpls.faTable(e)).find("table:first-child").stupidtable()}).fail(function(t,e,a){ErrorHandler.show("failed to load json data:"+x)})),b.add(v)&&b.refreshUI()}).fail(function(t,e,a){console.log("failed to load data:",k),404===t.status&&d>0&&"monthly"===h&&(console.log("try again",d),u("daily",d))})},p=function(e){return d.ta(e),e.opt=t.trunc(e.opt,2),e.factor=t.trunc(e.factor,1),t.debug("taFactor:",e),o.tmpls.taFactor({ta:e})},f=function(e){return d.fa(e),e.avg=t.trunc(e.avg,2),e.gap=t.trunc(e.gap,3),t.debug("faFactor:",e),o.tmpls.faFactor({fa:e})},d={ta:function(t){var e=t.stylish||{};t.major.r2<.3?e.r2="red":t.major.r2<.5?e.r2="olive":t.major.r2>.8?e.r2="green":e.r2="teal",t.stylish=e},fa:function(t){var e=t.stylish||{};t.avg.cra<=0?e.avg="down red":e.avg="up green";e.gap={},Object.getOwnPropertyNames(t.gap).forEach(function(a){t.gap[a]>10?e.gap[a]="red":t.gap[a]<-10?e.gap[a]="green":t.gap[a]<=10&&t.gap[a]>=-10&&(e.gap[a]="yellow")}),t.stylish=e}},m=function(t,e){Array.isArray(t)&&(3===t.length?t.push(e):t[3]=e)},y=function(t,e){var a,r=$(t);if(r.length>0)for(var n=0;n<r.length;n++)"DIV"===(a=r.get(n)).nodeName&&(e[a.id]=o.template(a.innerHTML))},b={_key1:"lv",_key2:"lv2",_view:function(t,e){var a=t.map(function(t,a){return[t,e[a]]});global.$lastVisit.html(o.tmpls.visitLabel({l:a}))},add:function(t){var e=localStorage.getItem(this._key1),a=t.c+":"+t.cat,o=t.n.split("-").pop();return null===e||""===e?(localStorage.setItem(this._key1,a),localStorage.setItem(this._key2,o),!0):e.indexOf(a)<0&&(localStorage.setItem(this._key1,e+"|"+a),localStorage.setItem(this._key2,localStorage.getItem(this._key2)+"|"+o),!0)},remove:function(t){var e=localStorage.getItem(this._key1),a=localStorage.getItem(this._key2),o=t.split("#");if(e&&o.length>1){var r=e.split("|"),n=a.split("|"),l=r.indexOf(o[1]);if(l>=0)return r.splice(l,1),n.splice(l,1),localStorage.setItem(this._key1,r.join("|")),localStorage.setItem(this._key2,n.join("|")),!0}return!1},refreshUI:function(){var e,a;if(t.cookie.get(this._key1)){console.log("cookie -> localStorage"),localStorage.setItem(this._key1,t.cookie.get(this._key1)),t.cookie.del(this._key1),console.log("patch");var o,r,n=this;e=localStorage.getItem(this._key1).split("|"),a=[],require(["cn","hk","world","us","sg"],function(t,l,i,c,s){e.forEach(function(e){switch((r=e.split(":"))[1]){case"world":o=i.findByProperty("c",r[0]);break;case"us":o=c.findByProperty("c",r[0]);break;case"sg":o=s.findByProperty("c",r[0]);break;case"hk":o=l.findByProperty("c",r[0]);break;default:o=t.findByProperty("c",r[0])}o&&a.push(o.n.split("-").pop())}),e.length>0&&e.length==a.length&&(n._view(e,a),localStorage.setItem(n._key2,a.join("|")))})}else console.log("unpatch"),e=localStorage.getItem(this._key1).split("|"),a=localStorage.getItem(this._key2).split("|"),e.length>0&&e.length==a.length&&this._view(e,a)}}});