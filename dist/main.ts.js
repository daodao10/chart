require.config({baseUrl:"dist",paths:{typeahead:"../assets/js/typeahead.bundle.min",doT:"../assets/js/doT.min","hc-theme":"../assets/highcharts/themes/grid",anounymous:"ProtoUtil","s-t":"../assets/js/stupidtable.min"},urlArgs:"_0.747"}).onError=function(t){throw console.log(t.requireType),"timeout"===t.requireType&&console.log("modules: "+t.requireModules),t},window.Promise||(console.log("patch to support Promise"),function(){var t,e,a,o,r=document.getElementsByTagName("script");e="assets/js/promise-6.1.0.min.js",(t=document.createElement("script")).src=e,t.async=a,o&&r?r[0].parentNode.insertBefore(t,r[0]):document.body.appendChild(t)}());var global={category:null,cr:{t:"©刀小一"},startDate:"2000-01",$factSet:null,opt:null,datum:null,maxTryTimes:2,cache:!0,debug:!1};!function(a,o){a.cacheScript=function(t,e){return e=a.extend(e||{},{dataType:"script",cache:o.cache,url:t}),a.ajax(e)},a.cacheJSON=function(t,e){return e=a.extend(e||{},{dataType:"json",cache:o.cache,url:t}),a.ajax(e)},a.cacheTemplate=function(t){var e={type:"GET",dataType:"html",cache:o.cache};return Array.isArray(t)?Promise.all(t.map(function(n){return new Promise(function(o,r){a.ajax(require.s.contexts._.config.baseUrl+"tmpl/"+n.file,e).done(function(t,e,a){o({id:n.id,content:t})}).fail(function(t,e,a){r(a)})})})):new Promise(function(t,e){e("template: cannot support")})}}(jQuery,global),ErrorHandler={_$error:null,init:function(){_$error=$("#error-panel > p"),window.onerror=function(t,e,a,o,r){ErrorHandler.show(t)}},show:function(t){_$error.text(t).parent().transition("fade")},hide:function(){_$error.parent().transition("hide")}},require(["u","t","f","doT","e","peg","e0","peg0","e1","peg1","anounymous","typeahead","hc-theme","s-t"],function(g,s,h,u,p,f,d,m,y,b){$.cacheTemplate([{file:"t-sets.html",id:"__set1"},{file:"f-t.html",id:"taFactor"},{file:"f-f.html",id:"faFactor"},{file:"f-f-t.html",id:"faTable"}]).then(function(t){var e={};t.forEach(function(t){t.id.startsWith("__")?a(t.content,e):e[t.id]=u.template(t.content)}),u.tmpls=e,$(function(){global.$factSet=[$("#fact-chart-0"),$("#fact-set-0"),$("#fact-chart-1"),$("#fact-chart-2"),$("#fact-set-1"),$("#fact-set-2"),$("#security-info")],global.$lastVisit=$("#last-visit"),global.$title=$("title"),ErrorHandler.init(),$(".menu .item").tab(),Promise.all(["world","cn","hk","sg","us"].map(function(a){return new Promise(function(e,t){require([a],function(t){e(t.map(function(t){return t.cat=a,t}))})})})).then(function(t){var o=[];t.forEach(function(t){o=o.concat(t)});var e=window.location.hash;if(e){var a=/#(\^?\w+):([a-z]*)/g.exec(decodeURIComponent(e));if(a&&3===a.length){var r=a[1].toUpperCase(),n=a[2].toLowerCase();global.category=n,l(o.find(function(t){return global.$title.text(t.n),t.c===r&&t.cat===n}))}$("#symbol").remove(),global.$lastVisit.remove()}else $("#symbol").focus(function(){$(this).select()}).typeahead({hint:!1,highlight:!0},{displayKey:"c",source:function(e,t){var a=50;e=e.toUpperCase(),t(o.filter(function(t){if(0<a&&(t.c.startsWith(e)||t.n.startsWith(e)))return a--,t}))},updater:function(t){},templates:{suggestion:u.tmpls.ticker}}).on("typeahead:selected",function(t,e,a){global.category=e.cat,l(e)}),S.refreshUI(),global.$lastVisit.on("click",".close",function(t){var e=$(this);S.remove(e.prev().attr("href"))&&(e.prev().remove(),e.remove())})}).catch(function(t){console.log("broken: "+t)}),$("#startDate").val(global.startDate).change(function(){var t=$(this).val();t&&0<t.length&&(t=t.replace("-","")),global.startDate=t}),$("#refreshBtn").click(function(){k(global.period,global.maxTryTimes)}),$(".message .close").on("click",function(){$(this).closest(".message").transition("fade")}),"localhost"===window.location.hostname?$("#add2watch").click(function(){if(global.opt){var t={n:global.datum.n,s:global.datum.c+":"+global.category,c:global.opt.c,o:global.opt.o,r:global.opt.r};console.dir(t),$.ajax({url:"http://localhost:3000/api/watchlist",crossDomain:!0,method:"POST",dataType:"json",data:t}).done(function(t){t.err?alert(t.msg):alert("done")})}}):$("#add2watch").remove()})}).catch(function(t){console.error(t)});var v=function(t){global.cr.x||(global.cr.x=t.plotWidth+t.plotLeft-100,global.cr.y=t.plotHeight+t.plotTop-10),t.renderer.text(global.cr.t,global.cr.x,global.cr.y).css({color:"#ccc",fontSize:"2em"}).attr({zIndex:99}).add()},l=function(t){global.period=g.getPeriod(global.category),global.datum=t,k(global.period,global.maxTryTimes)},k=function(r,o){var l=global.$factSet,c=global.datum,n=g.getCounterUrl(c.c,global.category,r),i=g.getFaUrl(global.category,c.c);o--;for(var t=0;t<6;t++)l[t].text("");l[6].next().text("SECTOR").next().text("CAPITAL"),ErrorHandler.hide(),$.cacheScript(n).done(function(t,e){data=data.filter(function(t){return t[0]>global.startDate&&.1<t[1]});var a=g.processData(data,{period:r,pv:c.pv});global.opt={c:a.cagr.CAGR,o:a.optimism,r:a.formula.r2},l[6].text(c.n).next().text(c.s),l[0].highcharts(s.getChartOptions(a),v);var o=g.Calc.ta(a),n={p:o.major.p,cagr:o.major.cagr,opt:o.opt};l[1].html(x(o)).find(".tooltip").popup({inline:!0}),"sg"==global.category||"us"==global.category?c.mv&&l[6].next().next().text("Shares {0} M, MarketCap: {1} M".format(c.mv.toFixed(4),(c.mv*n.p).toFixed(4))):"cn"!=global.category||c.c.startsWith("8")||c.c.startsWith("S")||(l[6].next().next().text("总股本 {0} 亿（{1}%流通），总市值 {2} 亿".format(Math.trunc(c.mv/1e3)/10,0<c.mv?Math.trunc(c.nv/c.mv*1e3)/10:NaN,Math.trunc(c.mv*n.p/1e3)/10)),$.cacheJSON(i).done(function(t,e){var a=g.toSeries(t.lastn),o=g.toSeries(t.ttm);global.debug||(l[2].highcharts(h.getChartOptions("FA - Annual",a)),l[3].highcharts(h.getChartOptions("FA - TTM",o)));var r=g.Calc.fa(n,a.roe);r.ttm=g.Calc.gn(n,o),r.peg=f[c.c],w(r.peg,"201704"),r.ee=p[c.c],r.ee&&(r.ee[13]="201704"),r.peg1=b[c.c],w(r.peg1,"201711"),r.ee1=y[c.c],r.ee1&&(r.ee1[13]="201711"),r.peg0=m[c.c],w(r.peg0,"201801"),r.ee0=d[c.c],l[4].html(_(r)).find(".tooltip").popup({inline:!0}),l[5].html(u.tmpls.faTable(t)).find("table:first-child").stupidtable()}).fail(function(t,e,a){ErrorHandler.show("failed to load json data:"+i)})),S.add(c)&&S.refreshUI()}).fail(function(t,e,a){console.log("failed to load data:",n),404===t.status&&0<o&&"monthly"===r&&(console.log("try again",o),k("daily",o))})},x=function(t){return e.ta(t),t.opt=g.trunc(t.opt,2),t.factor=g.trunc(t.factor,1),g.debug("taFactor:",t),u.tmpls.taFactor({ta:t})},_=function(t){return e.fa(t),t.avg=g.trunc(t.avg,2),t.gap=g.trunc(t.gap,3),g.debug("faFactor:",t),u.tmpls.faFactor({fa:t})},e={ta:function(t){var e=t.stylish||{};t.major.r2<.3?e.r2="red":t.major.r2<.5?e.r2="olive":.8<t.major.r2?e.r2="green":e.r2="teal",t.stylish=e},fa:function(e){var a=e.stylish||{};e.avg.cra<=0?a.avg="down red":a.avg="up green";a.gap={},Object.getOwnPropertyNames(e.gap).forEach(function(t){10<e.gap[t]?a.gap[t]="red":e.gap[t]<-10?a.gap[t]="green":e.gap[t]<=10&&-10<=e.gap[t]&&(a.gap[t]="yellow")}),e.stylish=a}},w=function(t,e){Array.isArray(t)&&(3===t.length?t.push(e):t[3]=e)},a=function(t,e){var a,o=$(t);if(0<o.length)for(var r=0;r<o.length;r++)"DIV"===(a=o.get(r)).nodeName&&(e[a.id]=u.template(a.innerHTML))},S={_key1:"lv",_key2:"lv2",_view:function(t,a){var e=t.map(function(t,e){return[t,a[e]]});global.$lastVisit.html(u.tmpls.visitLabel({l:e}))},add:function(t){var e=localStorage.getItem(this._key1),a=t.c+":"+t.cat,o=t.n.split("-").pop();return null===e||""===e?(localStorage.setItem(this._key1,a),localStorage.setItem(this._key2,o),!0):e.indexOf(a)<0&&(localStorage.setItem(this._key1,e+"|"+a),localStorage.setItem(this._key2,localStorage.getItem(this._key2)+"|"+o),!0)},remove:function(t){var e=localStorage.getItem(this._key1),a=localStorage.getItem(this._key2),o=t.split("#");if(e&&1<o.length){var r=e.split("|"),n=a.split("|"),l=r.indexOf(o[1]);if(0<=l)return r.splice(l,1),n.splice(l,1),localStorage.setItem(this._key1,r.join("|")),localStorage.setItem(this._key2,n.join("|")),!0}return!1},refreshUI:function(){var t,l;if(g.cookie.get(this._key1)){console.log("cookie -> localStorage"),localStorage.setItem(this._key1,g.cookie.get(this._key1)),g.cookie.del(this._key1),console.log("patch");var c,i,s=this;t=localStorage.getItem(this._key1).split("|"),l=[],require(["cn","hk","world","us","sg"],function(e,a,o,r,n){t.forEach(function(t){switch((i=t.split(":"))[1]){case"world":c=o.findByProperty("c",i[0]);break;case"us":c=r.findByProperty("c",i[0]);break;case"sg":c=n.findByProperty("c",i[0]);break;case"hk":c=a.findByProperty("c",i[0]);break;default:c=e.findByProperty("c",i[0])}c&&l.push(c.n.split("-").pop())}),0<t.length&&t.length==l.length&&(s._view(t,l),localStorage.setItem(s._key2,l.join("|")))})}else console.log("unpatch"),t=localStorage.getItem(this._key1).split("|"),l=localStorage.getItem(this._key2).split("|"),0<t.length&&t.length==l.length&&this._view(t,l)}}});