require.config({baseUrl:"dist",paths:{typeahead:"../assets/js/typeahead.bundle.min",doT:"../assets/js/doT.min","hc-theme":"../assets/highcharts/themes/grid",anounymous:"ProtoUtil","s-t":"../assets/js/stupidtable.min"},urlArgs:"_0.162"}).onError=function(t){throw console.log(t.requireType),"timeout"===t.requireType&&console.log("modules: "+t.requireModules),t},window.Promise||(console.log("patch to support Promise"),function(){var t,e,a,r,o=document.getElementsByTagName("script");e="assets/js/promise-6.1.0.min.js",(t=document.createElement("script")).src=e,t.async=a,r&&o?o[0].parentNode.insertBefore(t,o[0]):document.body.appendChild(t)}());var global={category:null,cr:{t:"©刀小一"},startDate:"1995-01",$factSet:null,datum:null,maxTryTimes:2,cache:!1,debug:!1};!function(t,e){t.cacheScript=function(a,r){return r=t.extend(r||{},{dataType:"script",cache:e.cache,url:a}),t.ajax(r)},t.cacheJSON=function(a,r){return r=t.extend(r||{},{dataType:"json",cache:e.cache,url:a}),t.ajax(r)},t.cacheTemplate=function(a){var r={type:"GET",dataType:"html",cache:e.cache};return Array.isArray(a)?Promise.all(a.map(function(e){return new Promise(function(a,o){t.ajax(require.s.contexts._.config.baseUrl+"tmpl/"+e.file,r).done(function(t,r,o){a({id:e.id,content:t})}).fail(function(t,e,a){o(a)})})})):new Promise(function(t,e){e("template: cannot support")})}}(jQuery,global),ErrorHandler={_$error:null,init:function(){_$error=$("#error-panel > p"),window.onerror=function(t,e,a,r,o){ErrorHandler.show(t)}},show:function(t){_$error.text(t).parent().transition("fade")},hide:function(){_$error.parent().transition("hide")}},require(["u","t","f","doT","e","peg","e0","peg0","e1","peg1","anounymous","typeahead","hc-theme","s-t"],function(t,e,a,r,o,n,c,l,i,s){$.cacheTemplate([{file:"t-sets.html",id:"__set1"},{file:"f-t.html",id:"taFactor"},{file:"f-f.html",id:"faFactor"},{file:"f-f-t.html",id:"faTable"}]).then(function(t){var e={};t.forEach(function(t){t.id.startsWith("__")?y(t.content,e):e[t.id]=r.template(t.content)}),r.tmpls=e,$(function(){global.$factSet=[$("#fact-chart-0"),$("#fact-set-0"),$("#fact-chart-1"),$("#fact-chart-2"),$("#fact-set-1"),$("#fact-set-2"),$("#security-info")];var t=$("#category"),e=$("#sector"),a=$("#symbol");ErrorHandler.init(),$(".menu .item").tab();var r=window.location.hash;if(r){var o=/#f=(-\d|\d)/g.exec(decodeURIComponent(r));o&&2===o.length&&(r=parseInt(o[1],10))}Promise.all(["world","cn","hk","sg","us"].map(function(e){return t.append(m(e,e.toUpperCase())),new Promise(function(t,a){require([e],function(a){t(a.filter(function(t){return t.cat=e,""===r||t.f===r}))})})})).then(function(r){var o,n={};r.forEach(function(t){t.forEach(function(t,e){0===e&&(n[t.cat]={}),t.s&&(n[t.cat][t.s]||(n[t.cat][t.s]={}),n[t.cat][t.s][t.c]=t)})}),t.change(function(t){var r=t.target.value;global.category=r,(o=Object.keys(n[r]).map(function(t){return m(t,t.toUpperCase())})).unshift(m("","-- sector --")),e.html(o.join("\n")),a.html(m("","-- security --"))}),e.change(function(t){var e=t.target.value,r=n[global.category][e];global.sector=e,(o=Object.keys(r).map(function(t){var e=r[t];return m(e.c,e.n)})).unshift(m("","-- security --")),a.html(o.join("\n"))}),a.change(function(t){var e=t.target.value;g(n[global.category][global.sector][e])})}).catch(function(t){console.log("broken: "+t.message)}),$("#startDate").val(global.startDate).change(function(){var t=$(this).val();t&&t.length>0&&(t=t.replace("-","")),global.startDate=t}),$("#refreshBtn").click(function(){f(global.period,global.maxTryTimes)}),$(".message .close").on("click",function(){$(this).closest(".message").transition("fade")})})}).catch(function(t){console.error(t)});var u=function(t){global.cr.x||(global.cr.x=t.plotWidth+t.plotLeft-100,global.cr.y=t.plotHeight+t.plotTop-10),t.renderer.text(global.cr.t,global.cr.x,global.cr.y).css({color:"#ccc",fontSize:"2em"}).attr({zIndex:99}).add()},g=function(e){global.period=t.getPeriod(global.category),global.datum=e,f(global.period,global.maxTryTimes)},f=function(g,d){var m=global.$factSet,y=global.datum,v=t.getCounterUrl(y.c,global.category,g),T=t.getFaUrl(global.category,y.c);d--;for(var x=0;x<6;x++)m[x].text("");m[6].text("CAPITAL"),ErrorHandler.hide(),$.cacheScript(v).done(function(f,d){data=data.filter(function(t){return t[0]>global.startDate});var v=t.processData(data,{period:g,pv:y.pv});m[0].highcharts(e.getChartOptions(v),u);var x=t.Calc.ta(v),j={p:x.major.p,cagr:x.major.cagr,opt:x.opt};m[1].html(p(x)).find(".tooltip").popup({inline:!0}),"sg"==global.category||"us"==global.category?y.mv&&m[6].text("Shares {0} M, MarketCap: {1} M".format(y.mv.toFixed(4),(y.mv*j.p).toFixed(4))):"cn"!=global.category||y.c.startsWith("8")||y.c.startsWith("S")||(m[6].text("总股本 {0} 亿（{1}%流通），总市值 {2} 亿".format(Math.trunc(y.mv/1e3)/10,y.mv>0?Math.trunc(y.nv/y.mv*1e3)/10:NaN,Math.trunc(y.mv*j.p/1e3)/10)),$.cacheJSON(T).done(function(e,u){var g=t.toSeries(e.lastn),f=t.toSeries(e.ttm);global.debug||(m[2].highcharts(a.getChartOptions("FA - Annual",g)),m[3].highcharts(a.getChartOptions("FA - TTM",f)));var p=t.Calc.fa(j,g.roe);p.ttm=t.Calc.gn(j,f),p.peg=n[y.c],b(p.peg,"201608"),p.ee=o[y.c],p.peg0=l[y.c],b(p.peg0,"201703"),p.ee0=c[y.c],p.peg1=s[y.c],b(p.peg1,"201612"),p.ee1=i[y.c],m[4].html(h(p)).find(".tooltip").popup({inline:!0}),m[5].html(r.tmpls.faTable(e)).find("table:first-child").stupidtable()}).fail(function(t,e,a){ErrorHandler.show("failed to load json data:"+T)}))}).fail(function(t,e,a){console.log("failed to load data:",v),404===t.status&&d>0&&"monthly"===g&&(console.log("try again",d),f("daily",d))})},p=function(e){return d.ta(e),e.opt=t.trunc(e.opt,2),e.factor=t.trunc(e.factor,1),t.debug("taFactor:",e),r.tmpls.taFactor({ta:e})},h=function(e){return d.fa(e),e.avg=t.trunc(e.avg,2),e.gap=t.trunc(e.gap,3),t.debug("faFactor:",e),r.tmpls.faFactor({fa:e})},d={ta:function(t){var e=t.stylish||{};t.major.r2<.3?e.r2="red":t.major.r2<.5?e.r2="olive":t.major.r2>.8?e.r2="green":e.r2="teal",t.stylish=e},fa:function(t){var e=t.stylish||{};t.avg.cra<=0?e.avg="down red":e.avg="up green";e.gap={},Object.getOwnPropertyNames(t.gap).forEach(function(a){t.gap[a]>10?e.gap[a]="red":t.gap[a]<-10?e.gap[a]="green":t.gap[a]<=10&&t.gap[a]>=-10&&(e.gap[a]="yellow")}),t.stylish=e}},m=function(t,e){return"<option value='{0}'>{1}</option>".format(t,e)},b=function(t,e){Array.isArray(t)&&(3===t.length?t.push(e):t[3]=e)},y=function(t,e){var a,o=$(t);if(o.length>0)for(var n=0;n<o.length;n++)"DIV"===(a=o.get(n)).nodeName&&(e[a.id]=r.template(a.innerHTML))}});