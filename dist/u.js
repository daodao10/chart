define(function(){"use strict";function D(r,a){return function(){if(!a||"object"!=typeof a)return r;for(var t,n=Object.keys(a),e=n.length;e--;)t=r[n[e]],Object(t)===t?D(r[n[e]],a[n[e]]):r[n[e]]=a[n[e]];return r}()}function t(){}function S(t,n){return n?new Date(Date.UTC(parseInt(t.substring(0,4),10),parseInt(t.substring(4,6),10)-1,parseInt(t.substring(6,8)))).getTime():new Date(Date.UTC(parseInt(t.substring(0,4),10),parseInt(t.substring(5,7),10)-1,parseInt(t.substring(8,10)))).getTime()}var T=function(t,n){for(var e={},r=t.length,a=0,o=0,i=0,u=0,p=0,c=0;c<r;c++)a+=n[c],o+=t[c],i+=n[c]*t[c],u+=n[c]*n[c],p+=t[c]*t[c];return e.slope=(r*i-a*o)/(r*u-a*a),e.intercept=(o-e.slope*a)/r,e.r2=Math.pow((r*i-a*o)/Math.sqrt((r*u-a*a)*(r*p-o*o)),2),e.toString=function(){return"y = {0} * x {1} {2}, r2 = {3}".format(e.slope,0<e.intercept?"+":"-",Math.abs(e.intercept),e.r2)},e},j=function(a,o){return{y:function(t,n){var e=[];void 0===n&&(n=0);for(var r=0;r<t.length;r++)e.push(a*t[r]+o+n);return e},yi:function(t,n){return void 0===n&&(n=0),a*t+o+n}}};function n(t,n){return t[0]<n[0]}var k={average:function(t){return t.reduce(function(t,n){return[0,t[1]+n[1]]})[1]/t.length},fa:function(t,n){var e=this.average(n),r={ar:e,crr:100*(n[0][1]/e-1),cra:n[0][1]-e};r.crr=0<r.cra?Math.abs(r.crr):-Math.abs(r.crr);var a=100*(t.p/t.opt.p50-1);return{avg:r,gap:{g1:a,g2:t.cagr-e,g3:a-r.cra,g4:a-r.crr}}},gn:function(t,n){var e=n.nav[0][1],r=function(t){if(Array.isArray(t)){var n=Math.ceil(new Date(t[0][0]).getMonth()/3);return 4*t[0][1]/n}throw new Error("arguments supported")}(n.eps);return{pb:t.p/e,pe:t.p/r,ey:r/t.p*100,n:0==e||0==r?0:t.p*t.p/(e*r)}},ta:function(t){var n=t.trendline,e=t.trendline[0].length-1,r=t.source[e],a=r[1],o={p50:n[0][e][1],p100:n[1][e][1],p75:n[2][e][1],p25:n[3][e][1],p0:n[4][e][1]},i={sf:100*(o.p100/o.p0-1),pf:100*(o.p75/o.p25-1),rf:100*(o.p0/o.p25-1),tp0:100*(o.p0/a-1),tp25:100*(o.p25/a-1),tp50:100*(o.p50/a-1),tp75:100*(o.p75/a-1),tp100:100*(o.p100/a-1)},u=Math.abs(i.tp75/i.tp0).toFixed(2);return{major:{start:new Date(t.source[0][0]),end:new Date(r[0]),p:a,opt:t.optimism,cagr:100*t.cagr.CAGR,r2:t.formula.r2,times:t.times},opt:o,factor:i,r:o.tp75<a?-u:o.p0<a?u:"N.A."}},CAGR:function(t,n){var e=31536e6/(n.x-t.x),r={CAGR:Math.pow(n.y/t.y,e)-1,period:1/e};return r}};return{extend:D,debug:t,toUtcDate:S,trunc:function(n,e){var r={};return Object.getOwnPropertyNames(n).forEach(function(t){"number"==typeof n[t]&&(r[t]=n[t].toFixed(e))}),r},Calc:k,getPeriod:function(t){return"world"===t?"monthly":"daily"},getCounterUrl:function(t,n,e){return"daily"===e?"{0}/{1}_d.js".format(n,t):"monthly"===e?"{0}/{1}_m.js".format(n,t):"{0}/{1}_w.js".format(n,t)},getFaUrl:function(t,n){return"fa/{0}/{1}.json".format(t,n)},processData:function(t,e){e=D({CagrSetting:{monthly:{count:20,distance:13},weekly:{count:30,distance:55},daily:{count:30,distance:250}},OptSetting:{monthly:{count:10,distance:3},weekly:{count:10,distance:13},daily:{count:30,distance:55}},period:"daily",generatePV:!1},e);for(var n,r,a=[],o=[],i=[],u={},p=0;p<t.length;p++)(r=t[p])[0]=S(r[0],!0),0==p&&(n=r[0],u.min=r[1],u.max=r[1]),o.push((r[0]-n)/1e4),i.push(Math.log(r[1])/Math.LN2),a.push(r),u.max=Math.max(u.max,r[1]),u.min=Math.min(u.min,r[1]);e.times=u.max/u.min,e.times;var c=T(i,o),s=new j(c.slope,c.intercept);c.toString();var f=s.y(o).map(function(t,n){return[a[n][0],Math.pow(2,t)]});u=i=o=null;var g,l,m,h=[],v=f.map(function(t,n){return e.pv&&(e.pv[0]==t[0]?h[0]=a[n][1]/t[1]:e.pv[1]==t[0]&&(h[1]=a[n][1]/t[1])),[n,a[n][1]/t[1]]});if(2!==h.length&&(g=v.clone(),e.OptSetting[e.period].count,e.OptSetting[e.period].distance,g.sort(function(t,n){return t[1]-n[1]}),e.generatePV&&(e.pv=[a[g[0][0]][0],a[g.slice(-1)[0][0]][0]]),h=[g[0][1],g.slice(-1)[0][1]]),e.pv,h&&2===h.length)var d=f.map(function(t){return[t[0],h[1]*t[1]]}),y=f.map(function(t){return[t[0],Math.sqrt(h[1])*t[1]]}),M=f.map(function(t){return[t[0],Math.sqrt(h[0])*t[1]]}),w=f.map(function(t){return[t[0],h[0]*t[1]]}),b=(l=v[v.length-1][1],m=h,1<l?100*(Math.log(l)/Math.log(m[1])/2+.5):100*(.5-Math.log(l)/Math.log(m[0])/2));var x=function(t,n,e){var r=t.filter(function(t){return 0<=t[1]&&t[1]<.05});r.sort(function(t,n){return t[1]-n[1]}),r.length<n?n=r.length:r=r.slice(0,n);for(var a,o=1;o<n&&(-e<(a=r[o][0]-r[0][0])&&a<e);o++);return o===n||0===r.length?null:r[0][0]<r[o][0]?[r[0][0],r[o][0]]:[r[o][0],r[0][0]]}(v.map(function(t,n){return[n,Math.abs(t[1]-1)]}),e.CagrSetting[e.period].count,e.CagrSetting[e.period].distance);if(x)var C=k.CAGR({x:a[x[0]][0],y:a[x[0]][1]},{x:a[x[1]][0],y:a[x[1]][1]});return{source:a,formula:c,trendline:[f,d,y,M,w],optimism:b,cagr:C,pv:e.generatePV?e.pv:null,times:e.times}},toSeries:function(t){var e,r={eps:[],nav:[],roe:[],ocf:[],gpm:[]};return t.forEach(function(t,n){4<n||(e=S(t[0]),r.eps.push([e,t[1]]),r.nav.push([e,t[2]]),r.roe.push([e,t[3]]),r.ocf.push([e,t[4]]),r.gpm.push([e,t[5]]))}),r.eps.sort(n),r.nav.sort(n),r.roe.sort(n),r.ocf.sort(n),r.gpm.sort(n),r},cookie:{set:function(t,n){var e=new Date;e.setTime(e.getTime()+2592e6),document.cookie=t+"="+escape(n)+";expires="+e.toGMTString()},get:function(t){var n,e=new RegExp("(^| )"+t+"=([^;]*)(;|$)");return(n=document.cookie.match(e))?unescape(n[2]):null},del:function(t){var n=new Date;n.setTime(n.getTime()-1);var e=this.get(t);null!=e&&(document.cookie=t+"="+e+";expires="+n.toGMTString())}}}});