define(function(){"use strict";function t(n,e){var r=function(t){return Object(t)===t};return function(){if(!e||"object"!=typeof e)return n;for(var o=Object.keys(e),a=o.length;a--;)r(n[o[a]])?t(n[o[a]],e[o[a]]):n[o[a]]=e[o[a]];return n}()}function n(){if(o){var t=arguments.length;1==t?console.log(arguments[0]):2==t?console.log(arguments[0],arguments[1]):3==t?console.log(arguments[0],arguments[1],arguments[2]):4==t?console.log(arguments[0],arguments[1],arguments[2],arguments[3]):5==t?console.log(arguments[0],arguments[1],arguments[2],arguments[3],arguments[4]):console.log(arguments)}}function e(t,n){return n?new Date(Date.UTC(parseInt(t.substring(0,4),10),parseInt(t.substring(4,6),10)-1,parseInt(t.substring(6,8)))).getTime():new Date(Date.UTC(parseInt(t.substring(0,4),10),parseInt(t.substring(5,7),10)-1,parseInt(t.substring(8,10)))).getTime()}function r(t,n){return t[0]<n[0]}var o=!1,a=function(t,n){for(var e={},r=t.length,o=0,a=0,i=0,u=0,c=0,p=0;p<r;p++)o+=n[p],a+=t[p],i+=n[p]*t[p],u+=n[p]*n[p],c+=t[p]*t[p];return e.slope=(r*i-o*a)/(r*u-o*o),e.intercept=(a-e.slope*o)/r,e.r2=Math.pow((r*i-o*a)/Math.sqrt((r*u-o*o)*(r*c-a*a)),2),e.toString=function(){return"y = {0} * x {1} {2}, r2 = {3}".format(e.slope,e.intercept>0?"+":"-",Math.abs(e.intercept),e.r2)},e},i={average:function(t){return t.reduce(function(t,n){return[0,t[1]+n[1]]})[1]/t.length},fa:function(t,n){var e=this.average(n),r={ar:e,crr:100*(n[0][1]/e-1),cra:n[0][1]-e};r.crr=r.cra>0?Math.abs(r.crr):-Math.abs(r.crr);var o=100*(t.p/t.opt.p50-1);return{avg:r,gap:{g1:o,g2:t.cagr-e,g3:o-r.cra,g4:o-r.crr}}},gn:function(t,n){var e=n.nav[0][1],r=function(t){if(Array.isArray(t)){var n=Math.ceil(new Date(t[0][0]).getMonth()/3);return 4*t[0][1]/n}throw new Error("arguments supported")}(n.eps);return{pb:t.p/e,pe:t.p/r,ey:r/t.p*100,n:0==e||0==r?0:t.p*t.p/(e*r)}},ta:function(t){var n=t.trendline,e=t.trendline[0].length-1,r=t.source[e],o=r[1],a={p50:n[0][e][1],p100:n[1][e][1],p75:n[2][e][1],p25:n[3][e][1],p0:n[4][e][1]},i={sf:100*(a.p100/a.p0-1),pf:100*(a.p75/a.p25-1),rf:100*(a.p0/a.p25-1),tp0:100*(a.p0/o-1),tp25:100*(a.p25/o-1),tp50:100*(a.p50/o-1),tp75:100*(a.p75/o-1),tp100:100*(a.p100/o-1)},u=Math.abs(i.tp75/i.tp0).toFixed(2);return{major:{start:new Date(t.source[0][0]),end:new Date(r[0]),p:o,opt:t.optimism,cagr:100*t.cagr.CAGR,r2:t.formula.r2,times:t.times},opt:a,factor:i,r:o>a.tp75?-u:o>a.p0?u:"N.A."}},CAGR:function(t,n){var e=31536e6/(n.x-t.x),r={CAGR:Math.pow(n.y/t.y,e)-1,period:1/e};return o&&(console.log("period",r.period,"Year(s)"),console.log("CAGR",r.CAGR)),r}};return{extend:t,debug:n,toUtcDate:e,trunc:function(t,n){var e={};return Object.getOwnPropertyNames(t).forEach(function(r){"number"==typeof t[r]&&(e[r]=t[r].toFixed(n))}),e},Calc:i,getPeriod:function(t){return"world"===t?"monthly":"daily"},getCounterUrl:function(t,n,e){return"daily"===e?"{0}/{1}_d.js".format(n,t):"monthly"===e?"{0}/{1}_m.js".format(n,t):"{0}/{1}_w.js".format(n,t)},getFaUrl:function(t,n){return"fa/{0}/{1}.json".format(t,n)},processData:function(r,o){o=t({CagrSetting:{monthly:{count:20,distance:13},weekly:{count:30,distance:55},daily:{count:30,distance:250}},OptSetting:{monthly:{count:10,distance:3},weekly:{count:10,distance:13},daily:{count:30,distance:55}},period:"daily",generatePV:!1},o);for(var u,c,p=[],s=[],l=[],g={},f=0;f<r.length;f++)(c=r[f])[0]=e(c[0],!0),0==f&&(u=c[0],g.min=c[1],g.max=c[1]),s.push((c[0]-u)/1e4),l.push(Math.log(c[1])/Math.LN2),p.push(c),g.max=Math.max(g.max,c[1]),g.min=Math.min(g.min,c[1]);o.times=g.max/g.min,n("times:",g,o.times);var m=a(l,s),h=new function(t,n){return{y:function(e,r){var o=[];void 0===r&&(r=0);for(var a=0;a<e.length;a++)o.push(t*e[a]+n+r);return o},yi:function(e,r){return void 0===r&&(r=0),t*e+n+r}}}(m.slope,m.intercept);n(m.toString());var v=h.y(s).map(function(t,n){return[p[n][0],Math.pow(2,t)]});s=null,l=null,g=null;var d=[],y=v.map(function(t,n){return o.pv&&(o.pv[0]==t[0]?d[0]=p[n][1]/t[1]:o.pv[1]==t[0]&&(d[1]=p[n][1]/t[1])),[n,p[n][1]/t[1]]});if(2!==d.length&&(d=function(t,n,e){return t.sort(function(t,n){return t[1]-n[1]}),o.generatePV&&(o.pv=[p[t[0][0]][0],p[t.slice(-1)[0][0]][0]]),[t[0][1],t.slice(-1)[0][1]]}(y.clone(),o.OptSetting[o.period].count,o.OptSetting[o.period].distance)),n("PV",o.pv),n("OPT pick",d),d&&2===d.length)var M=v.map(function(t){return[t[0],d[1]*t[1]]}),w=v.map(function(t){return[t[0],Math.sqrt(d[1])*t[1]]}),b=v.map(function(t){return[t[0],Math.sqrt(d[0])*t[1]]}),x=v.map(function(t){return[t[0],d[0]*t[1]]}),C=function(t,e){var r=0;return r=t>1?100*(Math.log(t)/Math.log(e[1])/2+.5):100*(.5-Math.log(t)/Math.log(e[0])/2),n(r),r}(y[y.length-1][1],d);var D=function(t,n,e){var r=t.filter(function(t){return t[1]>=0&&t[1]<.05});r.sort(function(t,n){return t[1]-n[1]}),r.length<n?n=r.length:r=r.slice(0,n);for(var o,a=1;a<n&&(o=r[a][0]-r[0][0],-e<o&&o<e);a++);return a===n||0===r.length?null:r[0][0]<r[a][0]?[r[0][0],r[a][0]]:[r[a][0],r[0][0]]}(y.map(function(t,n){return[n,Math.abs(t[1]-1)]}),o.CagrSetting[o.period].count,o.CagrSetting[o.period].distance);if(D){n("CAGR pick",D);var S=i.CAGR({x:p[D[0]][0],y:p[D[0]][1]},{x:p[D[1]][0],y:p[D[1]][1]})}return{source:p,formula:m,trendline:[v,M,w,b,x],optimism:C,cagr:S,pv:o.generatePV?o.pv:null,times:o.times}},toSeries:function(t){var n,o={eps:[],nav:[],roe:[],ocf:[],gpm:[]};return t.forEach(function(t,r){r>4||(n=e(t[0]),o.eps.push([n,t[1]]),o.nav.push([n,t[2]]),o.roe.push([n,t[3]]),o.ocf.push([n,t[4]]),o.gpm.push([n,t[5]]))}),o.eps.sort(r),o.nav.sort(r),o.roe.sort(r),o.ocf.sort(r),o.gpm.sort(r),o},cookie:{set:function(t,n){var e=new Date;e.setTime(e.getTime()+2592e6),document.cookie=t+"="+escape(n)+";expires="+e.toGMTString()},get:function(t){var n,e=new RegExp("(^| )"+t+"=([^;]*)(;|$)");return(n=document.cookie.match(e))?unescape(n[2]):null},del:function(t){var n=new Date;n.setTime(n.getTime()-1);var e=this.get(t);null!=e&&(document.cookie=t+"="+e+";expires="+n.toGMTString())}}}});